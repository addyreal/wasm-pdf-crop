const main=document.getElementById("main"),outputElement=document.getElementById("output"),pdf_input=document.getElementById("input"),_c_highdpi=document.getElementById("_c_highdpi"),preview_container=document.getElementById("preview_container"),preview_canvas=document.getElementById("preview_canvas"),_c_preview_view=document.getElementById("_c_preview_view"),_c_preview_hide=document.getElementById("_c_preview_hide"),_c_preview_reset=document.getElementById("_c_preview_reset"),config_container=document.getElementById("config_container"),multipage_help=document.getElementById("multipage_help"),multipage_prev=document.getElementById("multipage_prev"),multipage_next=document.getElementById("multipage_next"),multipage_count=document.getElementById("multipage_count"),action_button=document.getElementById("action_button");var filename="",fileBuffer=null,PDFDoc=null,num_pages=0,renderInProgress=!1;async function renderPDFPage(e){const t=await PDFDoc.getPage(e),r=t.getViewport({scale:CONST_DPI/72});canvas.width=r.width>=600?600:r.width,canvas.height=r.height>=600?600:r.height,vCanvas.width=r.width,vCanvas.height=r.height;const o=t.render({canvasContext:vContext,viewport:r});await o.promise}function getLineCount(e){return e.value.split("\n").length-1}function resizeOutput(e){e.style.height="calc(1.2rem * "+getLineCount(e)+" + 70px)"}function clearOutput(e){e.value=""}clearOutput(outputElement);const canvas=document.getElementById("canvas"),context=canvas.getContext("2d");context.imageSmoothingEnabled=!1;const vCanvas=document.createElement("canvas"),vContext=vCanvas.getContext("2d");vContext.imageSmoothingEnabled=!1;var CONST_DPI=144;const CONST_CROPTHICKNESS=1,CONST_ZOOMFACTOR=1.1,CONST_MOBILEZOOMFACTOR=1.05;function draw(){context.setTransform(1,0,0,1,0,0),context.clearRect(0,0,canvas.width,canvas.height),context.imageSmoothingEnabled=!1,context.setTransform(previewWindow.scale,0,0,previewWindow.scale,previewWindow.offsetX,previewWindow.offsetY),context.drawImage(vCanvas,0,0),context.setTransform(1,0,0,1,0,0);const e=Math.round(cropRect.x)*previewWindow.scale+previewWindow.offsetX+.5*previewWindow.scale,t=Math.round(cropRect.y)*previewWindow.scale+previewWindow.offsetY+.5*previewWindow.scale,r=Math.round(cropRect.w)*previewWindow.scale,o=Math.round(cropRect.h)*previewWindow.scale;context.save(),context.fillStyle="rgba(0, 0, 0, 0.4)",context.fillRect(e-.5*previewWindow.scale,t-.5*previewWindow.scale,r,o),context.restore(),context.strokeStyle="rgba(255, 0, 0 , 0.6)",context.lineWidth=1*previewWindow.scale,context.strokeRect(e,t,r,o)}function press(e,t){const r=canvas.getBoundingClientRect();previewWindow.isDragging=!0,previewWindow.isTouchZooming=!1,previewWindow.lastX=e-r.left,previewWindow.lastY=t-r.top}function move(e,t){if(!previewWindow.isDragging||previewWindow.isTouchZooming)return;const r=canvas.getBoundingClientRect(),o=e-r.left-previewWindow.lastX,c=t-r.top-previewWindow.lastY;previewWindow.offsetX+=o,previewWindow.offsetY+=c,previewWindow.lastX=e-r.left,previewWindow.lastY=t-r.top,draw()}function zoom(e){const t=canvas.getBoundingClientRect(),r=e.clientX-t.left,o=e.clientY-t.top,c=e.deltaY<=0?1.1:1/1.1,n=(r-previewWindow.offsetX)/previewWindow.scale,i=(o-previewWindow.offsetY)/previewWindow.scale;previewWindow.scale*=c,previewWindow.offsetX=r-n*previewWindow.scale,previewWindow.offsetY=o-i*previewWindow.scale,draw()}function end(){previewWindow.isDragging=!1,cropRect.dragging=!1,canvas.classList.remove("grabbing")}function getTouchesDist(e,t){const r=e.clientX-t.clientX,o=e.clientY-t.clientY;return Math.hypot(r,o)}function getTouchesX(e,t){return(e.clientX+t.clientX)/2}function getTouchesY(e,t){return(e.clientY+t.clientY)/2}function mobileStartZoom(e,t){cropRect.dragging=!1,previewWindow.isDragging=!1,previewWindow.isTouchZooming=!0,previewWindow.lastTouchesDist=getTouchesDist(e,t)}function mobileZoom(e,t){const r=canvas.getBoundingClientRect(),o=getTouchesX(e,t)-r.left,c=getTouchesY(e,t)-r.top,n=getTouchesDist(e,t)-previewWindow.lastTouchesDist<=0?1/1.05:1.05,i=(o-previewWindow.offsetX)/previewWindow.scale,s=(c-previewWindow.offsetY)/previewWindow.scale;previewWindow.scale*=n,previewWindow.offsetX=o-i*previewWindow.scale,previewWindow.offsetY=c-s*previewWindow.scale,previewWindow.lastTouchesDist=getTouchesDist(e,t),draw()}function mobileEnd(){cropRect.dragging=!1,previewWindow.isDragging=!1,previewWindow.isTouchZooming=!1}var previewWindow={scale:1,lastTouchesDist:0,lastX:0,lastY:0,offsetX:0,offsetY:0,isDragging:!1,isTouchZooming:!1};function resetPreviewWindow(){previewWindow={scale:1,lastTouchesDist:0,lastX:0,lastY:0,offsetX:0,offsetY:0,isDragging:!1,isTouchZooming:!1}}var cropRect={x:0,y:0,w:0,h:0,lastX:0,lastY:0,offsetX:0,offsetY:0,vertex:0,dragging:!1},cropArray={current:1,total:1,saved:[{x:0,y:0,w:0,h:0}],sizes:[{pw:0,ph:0}]};function saveCurrentCrop(e){const t=cropArray.current-1,r=cropRect.x,o=cropRect.y,c=cropRect.w,n=cropRect.h;cropArray.saved[t]={x:r,y:o,w:c,h:n};const i=e.width-1,s=e.height-1;cropArray.sizes[t]={pw:i,ph:s}}function resetCurrentCrop(e){cropRect={x:0,y:0,w:e.width-1,h:e.height-1,lastX:0,lastY:0,offsetX:0,offsetY:0,vertex:0,dragging:!1}}function restoreCurrentCrop(e,t){0!=cropArray.saved[e-1].w?cropRect={x:cropArray.saved[e-1].x,y:cropArray.saved[e-1].y,w:cropArray.saved[e-1].w,h:cropArray.saved[e-1].h,lastX:0,lastY:0,offsetX:0,offsetY:0,vertex:0,dragging:!1}:resetCurrentCrop(t)}function resetCropArray(e){cropArray={current:1,total:e,saved:Array.from({length:e},(()=>({x:0,y:0,w:0,h:0}))),sizes:Array.from({length:e},(()=>({pw:0,ph:0})))}}pdfjsLib.GlobalWorkerOptions.workerSrc="pdf.worker.min.js",pdf_input.onchange=async e=>{config_container.classList.add("hidden"),multipage_help.classList.add("hidden");const t=e.target.files[0];if(!t)return;filename=t.name.replace(/\.pdf$/i,"");const r=await t.arrayBuffer();fileBuffer=r.slice(0),PDFDoc=await pdfjsLib.getDocument({data:r}).promise,renderInProgress=!0,await renderPDFPage(1),renderInProgress=!1,resetCurrentCrop(vCanvas),resetPreviewWindow(),resetCropArray(num_pages=PDFDoc.numPages),draw(),config_container.classList.remove("hidden"),num_pages>1&&(multipage_help.classList.remove("hidden"),multipage_count.innerHTML=cropArray.current+"/"+cropArray.total)},canvas.addEventListener("wheel",(e=>{e.preventDefault(),zoom(e)})),canvas.addEventListener("mousedown",(e=>{canvas.classList.add("grabbing");const t=canvas.getBoundingClientRect(),r=e.clientX-t.left,o=e.clientY-t.top,c=cropRect.x*previewWindow.scale+previewWindow.offsetX,n=cropRect.y*previewWindow.scale+previewWindow.offsetY,i=cropRect.w*previewWindow.scale,s=cropRect.h*previewWindow.scale;r>=c-previewWindow.scale-10&&r<=c+previewWindow.scale+10&&o>=n-previewWindow.scale-10&&o<=n+previewWindow.scale+10?(cropRect.lastX=(r-previewWindow.offsetX)/previewWindow.scale,cropRect.lastY=(o-previewWindow.offsetY)/previewWindow.scale,cropRect.offsetX=0,cropRect.offsetY=0,cropRect.vertex=1,cropRect.dragging=!0):r>=c+i-previewWindow.scale-10&&r<=c+i+previewWindow.scale+10&&o>=n-previewWindow.scale-10&&o<=n+previewWindow.scale+10?(cropRect.lastX=(r-previewWindow.offsetX)/previewWindow.scale,cropRect.lastY=(o-previewWindow.offsetY)/previewWindow.scale,cropRect.offsetX=0,cropRect.offsetY=0,cropRect.vertex=2,cropRect.dragging=!0):r>=c-previewWindow.scale-10&&r<=c+previewWindow.scale+10&&o>=n+s-previewWindow.scale-10&&o<=n+s+previewWindow.scale+10?(cropRect.lastX=(r-previewWindow.offsetX)/previewWindow.scale,cropRect.lastY=(o-previewWindow.offsetY)/previewWindow.scale,cropRect.offsetX=0,cropRect.offsetY=0,cropRect.vertex=3,cropRect.dragging=!0):r>=c+i-previewWindow.scale-10&&r<=c+i+previewWindow.scale+10&&o>=n+s-previewWindow.scale-10&&o<=n+s+previewWindow.scale+10?(cropRect.lastX=(r-previewWindow.offsetX)/previewWindow.scale,cropRect.lastY=(o-previewWindow.offsetY)/previewWindow.scale,cropRect.offsetX=0,cropRect.offsetY=0,cropRect.vertex=4,cropRect.dragging=!0):press(e.clientX,e.clientY)})),canvas.addEventListener("mousemove",(e=>{e.preventDefault();const t=canvas.getBoundingClientRect(),r=e.clientX-t.left,o=e.clientY-t.top;if(1==cropRect.dragging){const e=(r-cropRect.offsetX-previewWindow.offsetX)/previewWindow.scale,t=(o-cropRect.offsetY-previewWindow.offsetY)/previewWindow.scale;let c=e-cropRect.lastX,n=t-cropRect.lastY;switch(cropRect.vertex){case 1:cropRect.x+=c,cropRect.y+=n,cropRect.w-=c,cropRect.h-=n;break;case 2:cropRect.y+=n,cropRect.w+=c,cropRect.h-=n;break;case 3:cropRect.x+=c,cropRect.w-=c,cropRect.h+=n;break;case 4:cropRect.w+=c,cropRect.h+=n}cropRect.lastX=e,cropRect.lastY=t,draw()}else move(e.clientX,e.clientY)})),canvas.addEventListener("mouseup",(()=>{end()})),canvas.addEventListener("mouseleave",(()=>{end()})),canvas.addEventListener("touchstart",(function(e){if(e.preventDefault(),1==e.touches.length){const t=canvas.getBoundingClientRect(),r=e.touches[0].clientX-t.left,o=e.touches[0].clientY-t.top,c=cropRect.x*previewWindow.scale+previewWindow.offsetX,n=cropRect.y*previewWindow.scale+previewWindow.offsetY,i=cropRect.w*previewWindow.scale,s=cropRect.h*previewWindow.scale;r>=c-previewWindow.scale-20&&r<=c+previewWindow.scale+20&&o>=n-previewWindow.scale-20&&o<=n+previewWindow.scale+20?(cropRect.lastX=(r-previewWindow.offsetX)/previewWindow.scale,cropRect.lastY=(o-previewWindow.offsetY)/previewWindow.scale,cropRect.offsetX=0,cropRect.offsetY=0,cropRect.vertex=1,cropRect.dragging=!0):r>=c+i-previewWindow.scale-20&&r<=c+i+previewWindow.scale+20&&o>=n-previewWindow.scale-20&&o<=n+previewWindow.scale+20?(cropRect.lastX=(r-previewWindow.offsetX)/previewWindow.scale,cropRect.lastY=(o-previewWindow.offsetY)/previewWindow.scale,cropRect.offsetX=0,cropRect.offsetY=0,cropRect.vertex=2,cropRect.dragging=!0):r>=c-previewWindow.scale-20&&r<=c+previewWindow.scale+20&&o>=n+s-previewWindow.scale-20&&o<=n+s+previewWindow.scale+20?(cropRect.lastX=(r-previewWindow.offsetX)/previewWindow.scale,cropRect.lastY=(o-previewWindow.offsetY)/previewWindow.scale,cropRect.offsetX=0,cropRect.offsetY=0,cropRect.vertex=3,cropRect.dragging=!0):r>=c+i-previewWindow.scale-20&&r<=c+i+previewWindow.scale+20&&o>=n+s-previewWindow.scale-20&&o<=n+s+previewWindow.scale+20?(cropRect.lastX=(r-previewWindow.offsetX)/previewWindow.scale,cropRect.lastY=(o-previewWindow.offsetY)/previewWindow.scale,cropRect.offsetX=0,cropRect.offsetY=0,cropRect.vertex=4,cropRect.dragging=!0):press(e.touches[0].clientX,e.touches[0].clientY)}else 2==e.touches.length&&mobileStartZoom(e.touches[0],e.touches[1])}),{passive:!1}),canvas.addEventListener("touchmove",(function(e){if(e.preventDefault(),1==e.touches.length)if(1==cropRect.dragging){const t=canvas.getBoundingClientRect(),r=e.touches[0].clientX-t.left,o=e.touches[0].clientY-t.top,c=(r-cropRect.offsetX-previewWindow.offsetX)/previewWindow.scale,n=(o-cropRect.offsetY-previewWindow.offsetY)/previewWindow.scale;let i=c-cropRect.lastX,s=n-cropRect.lastY;switch(cropRect.vertex){case 1:cropRect.x+=i,cropRect.y+=s,cropRect.w-=i,cropRect.h-=s;break;case 2:cropRect.y+=s,cropRect.w+=i,cropRect.h-=s;break;case 3:cropRect.x+=i,cropRect.w-=i,cropRect.h+=s;break;case 4:cropRect.w+=i,cropRect.h+=s}cropRect.lastX=c,cropRect.lastY=n,draw()}else move(e.touches[0].clientX,e.touches[0].clientY);else 2==e.touches.length&&mobileZoom(e.touches[0],e.touches[1])}),{passive:!1}),canvas.addEventListener("touchend",(()=>{mobileEnd()}),{passive:!1}),canvas.addEventListener("touchcancel",(()=>{mobileEnd()}),{passive:!1}),_c_highdpi.addEventListener("change",(e=>{CONST_DPI=e.target.checked?288:144,config_container.classList.add("hidden"),multipage_help.classList.add("hidden")})),_c_preview_view.addEventListener("click",(function(){preview_container.classList.toggle("hidden"),main.classList.toggle("blurred")})),_c_preview_reset.addEventListener("click",(()=>{resetPreviewWindow(),resetCurrentCrop(vCanvas),draw()})),_c_preview_hide.addEventListener("click",(function(){saveCurrentCrop(vCanvas),preview_container.classList.toggle("hidden"),main.classList.toggle("blurred")})),multipage_prev.addEventListener("click",(async function(){1==cropArray.current||renderInProgress||(renderInProgress=!0,saveCurrentCrop(vCanvas),cropArray.current-=1,await renderPDFPage(cropArray.current),restoreCurrentCrop(cropArray.current,vCanvas),draw(),multipage_count.innerHTML=cropArray.current+"/"+cropArray.total,renderInProgress=!1)})),multipage_next.addEventListener("click",(async function(){cropArray.current==cropArray.total||renderInProgress||(renderInProgress=!0,saveCurrentCrop(vCanvas),cropArray.current+=1,await renderPDFPage(cropArray.current),restoreCurrentCrop(cropArray.current,vCanvas),draw(),multipage_count.innerHTML=cropArray.current+"/"+cropArray.total,renderInProgress=!1)})),action_button.addEventListener("click",(function(){clearOutput(outputElement),resizeOutput(outputElement),(async()=>{const{PDFDocument:e}=PDFLib,t=await e.load(fileBuffer),r=e=>e*(72/CONST_DPI);for(let e=1;e<=num_pages;e++){const o=t.getPage(e-1),c=cropArray.sizes[e-1].pw,n=cropArray.sizes[e-1].ph,i=cropArray.saved[e-1],s=Math.round(i.x),a=n-Math.round(i.h)-Math.round(i.y),p=Math.round(i.w),w=Math.round(i.h);0!=p&&0!=w&&p!=c&&w!=n&&o.setCropBox(r(s),r(a),r(p),r(w))}newBytes=await t.save();const o=new Blob([newBytes],{type:"application/pdf"}),c=document.createElement("a");c.href=URL.createObjectURL(o),c.download=filename+"-cropped.pdf",c.click(),URL.revokeObjectURL(c.href)})()}));